name: Build & Release AARs (OpenSSL-aligned)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      OPENSSL_VERSION:
        description: 'OpenSSL version to build (required for manual dispatch)'
        required: false
        default: ''
      SKIP_OPENSSL_BUILD:
        description: 'Skip building OpenSSL (0 or 1)'
        required: false
        default: '0'
      SHIP_OPENSSL_SOURCE:
        description: 'Copy OpenSSL source to package folder (0 or 1)'
        required: false
        default: '1'
      SHIP_SOURCE_TO_AAR:
        description: 'Include OpenSSL source inside AAR assets (0 or 1)'
        required: false
        default: '0'
      INCLUDE_STATIC:
        description: 'Include .a static libs in package (0 or 1)'
        required: false
        default: '1'
      INCLUDE_SHARED:
        description: 'Include .so shared libs in package (0 or 1)'
        required: false
        default: '1'
      NDK:
        description: 'Android NDK version to install'
        required: false
        default: '21.4.7075529'

# Ensure the workflow has the necessary token permissions to create releases
# and publish packages. These can be tightened as needed.
permissions:
  contents: write
  packages: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      OPENSSL_VERSION: ${{ steps.set.outputs.OPENSSL_VERSION }}
      NDK: ${{ steps.set.outputs.NDK }}
      SKIP_OPENSSL_BUILD: ${{ steps.set.outputs.SKIP_OPENSSL_BUILD }}
      SHIP_OPENSSL_SOURCE: ${{ steps.set.outputs.SHIP_OPENSSL_SOURCE }}
      SHIP_SOURCE_TO_AAR: ${{ steps.set.outputs.SHIP_SOURCE_TO_AAR }}
      INCLUDE_STATIC: ${{ steps.set.outputs.INCLUDE_STATIC }}
      INCLUDE_SHARED: ${{ steps.set.outputs.INCLUDE_SHARED }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Derive inputs
        id: set
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "push" ]; then
            TAG=${{ github.ref_name }}
            OPENSSL_VERSION=${TAG#v}
          else
            OPENSSL_VERSION="${{ github.event.inputs.OPENSSL_VERSION }}"
          fi
          if [ -z "$OPENSSL_VERSION" ]; then
            echo "OPENSSL_VERSION must be provided (tag or workflow input)"
            exit 1
          fi
          echo "::set-output name=OPENSSL_VERSION::$OPENSSL_VERSION"
          echo "::set-output name=NDK::${{ github.event.inputs.NDK }}"
          echo "::set-output name=SKIP_OPENSSL_BUILD::${{ github.event.inputs.SKIP_OPENSSL_BUILD }}"
          echo "::set-output name=SHIP_OPENSSL_SOURCE::${{ github.event.inputs.SHIP_OPENSSL_SOURCE }}"
          echo "::set-output name=SHIP_SOURCE_TO_AAR::${{ github.event.inputs.SHIP_SOURCE_TO_AAR }}"
          echo "::set-output name=INCLUDE_STATIC::${{ github.event.inputs.INCLUDE_STATIC }}"
          echo "::set-output name=INCLUDE_SHARED::${{ github.event.inputs.INCLUDE_SHARED }}"

  build-openssl:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        abi: [armeabi-v7a, arm64-v8a, x86, x86_64]
        build_type: [release, debug]
    # Do not set runner.temp in YAML expressions (not supported). We'll use
    # the runtime $RUNNER_TEMP variable inside the shell steps instead.
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Install Android SDK & NDK (sdkmanager)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y unzip curl
          ANDROID_SDK_ROOT="$RUNNER_TEMP/android-sdk"
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          TMP_ZIP="/tmp/cmdline-tools.zip"
          curl -sSL https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -o "$TMP_ZIP"
          unzip -q "$TMP_ZIP" -d "$ANDROID_SDK_ROOT/cmdline-tools"
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools/bin:$PATH"
          yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --licenses || true
          sdkmanager --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-33" "ndk;${{ needs.prepare.outputs.NDK }}"
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/${{ needs.prepare.outputs.NDK }}" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
      - name: Build OpenSSL for matrix entry
        env:
          OPENSSL_VERSION: ${{ needs.prepare.outputs.OPENSSL_VERSION }}
          ABI: ${{ matrix.abi }}
          BUILD_TYPE: ${{ matrix.build_type }}
        run: |
          set -euo pipefail
          echo "Building for ABI=$ABI BUILD_TYPE=$BUILD_TYPE"
          # Run the build script restricted to the single ABI/build type
          ABIS=("$ABI")
          BUILD_TYPES=("$BUILD_TYPE")
          chmod +x ./scripts/build-openssl.sh
          ./scripts/build-openssl.sh
      - name: Upload OpenSSL artifact
        uses: actions/upload-artifact@v4
        with:
          name: openssl-${{ needs.prepare.outputs.OPENSSL_VERSION }}-${{ matrix.abi }}-${{ matrix.build_type }}
          path: third_party/openssl/${{ needs.prepare.outputs.OPENSSL_VERSION }}/${{ matrix.abi }}/${{ matrix.build_type }}

  package:
    needs: build-openssl
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      - name: Show downloaded artifacts
        run: ls -R artifacts || true
      - name: Setup Java (for Gradle)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Prepare SDK (sdkmanager)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y unzip curl
          ANDROID_SDK_ROOT="$HOME/android-sdk"
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          TMP_ZIP="/tmp/cmdline-tools.zip"
          curl -sSL https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -o "$TMP_ZIP"
          unzip -q "$TMP_ZIP" -d "$ANDROID_SDK_ROOT/cmdline-tools"
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools/bin:$PATH"
          yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --licenses || true
          sdkmanager --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-33"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
      - name: Restore built outputs into third_party
        run: |
          set -euo pipefail
          mkdir -p third_party/openssl/${{ needs.prepare.outputs.OPENSSL_VERSION }}
          for d in artifacts/*; do
            cp -a "$d"/* . || true
          done
      - name: Run packaging script
        env:
          OPENSSL_VERSION: ${{ needs.prepare.outputs.OPENSSL_VERSION }}
          SKIP_OPENSSL_BUILD: ${{ needs.prepare.outputs.SKIP_OPENSSL_BUILD }}
          SHIP_OPENSSL_SOURCE: ${{ needs.prepare.outputs.SHIP_OPENSSL_SOURCE }}
          SHIP_SOURCE_TO_AAR: ${{ needs.prepare.outputs.SHIP_SOURCE_TO_AAR }}
          INCLUDE_STATIC: ${{ needs.prepare.outputs.INCLUDE_STATIC }}
          INCLUDE_SHARED: ${{ needs.prepare.outputs.INCLUDE_SHARED }}
        run: |
          chmod +x ./scripts/package-aar.sh
          ./scripts/package-aar.sh
      - name: Create GitHub Release and upload package folder
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          artifacts: |
            native-sea-openssl-package/**
          skipIfReleaseExists: true
          makeLatest: true
